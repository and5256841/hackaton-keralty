<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Dashboard de Salud</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .patient-selector {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .patient-selector select {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .card h2 {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .patient-info {
            display: grid;
            gap: 10px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .info-label {
            font-weight: 600;
            color: #666;
        }

        .info-value {
            color: #333;
        }

        .risk-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .risk-healthy { background: #d4edda; color: #155724; }
        .risk-susceptible { background: #fff3cd; color: #856404; }
        .risk-stable_condition { background: #f8d7da; color: #721c24; }
        .risk-high_complexity { background: #d6d8db; color: #383d41; }

        .goals-section {
            grid-column: 1 / -1;
        }

        .goal-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .goal-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
        }

        .goal-status {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .status-not_started { background: #e9ecef; color: #495057; }
        .status-in_progress { background: #cfe2ff; color: #084298; }
        .status-completed { background: #d1e7dd; color: #0f5132; }
        .status-abandoned { background: #f8d7da; color: #842029; }

        .goal-description {
            color: #666;
            margin-bottom: 15px;
        }

        .goal-progress {
            margin-top: 10px;
        }

        .progress-bar-container {
            background: #e9ecef;
            height: 25px;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-bar {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.85em;
            transition: width 0.5s ease;
        }

        .goal-values {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .value-item {
            flex: 1;
        }

        .value-label {
            color: #666;
            font-size: 0.85em;
        }

        .value-number {
            font-weight: 600;
            color: #667eea;
            font-size: 1.1em;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè• Mi Dashboard de Salud</h1>
            <p>Tus objetivos y progreso personalizado</p>
        </header>

        <div class="patient-selector">
            <select id="patientSelect">
                <option value="">Selecciona tu perfil...</option>
            </select>
        </div>

        <div id="dashboardContent" style="display: none;">
            <div class="dashboard-grid">
                <div class="card">
                    <h2>üë§ Informaci√≥n Personal</h2>
                    <div class="patient-info" id="patientInfo"></div>
                </div>

                <div class="card">
                    <h2>üéØ Estado de Salud</h2>
                    <div id="healthStatus"></div>
                </div>

                <div class="card goals-section">
                    <h2>üìä Mis Objetivos de Salud</h2>
                    <div id="healthGoals"></div>
                </div>
            </div>
        </div>

        <div class="loading" id="loading" style="display: none;">
            <p>‚è≥ Cargando tu informaci√≥n...</p>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        const patientSelect = document.getElementById('patientSelect');
        const dashboardContent = document.getElementById('dashboardContent');
        const loading = document.getElementById('loading');

        // Load patients
        async function loadPatients() {
            try {
                const response = await fetch(`${API_URL}/patients/?limit=50`);
                const patients = await response.json();

                patients.forEach(patient => {
                    const option = document.createElement('option');
                    option.value = patient.id;
                    option.textContent = `${patient.first_name} ${patient.last_name}`;
                    patientSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading patients:', error);
            }
        }

        // Load patient dashboard
        async function loadPatientDashboard(patientId) {
            loading.style.display = 'block';
            dashboardContent.style.display = 'none';

            try {
                // Get patient with digital twin
                const patientResponse = await fetch(`${API_URL}/patients/${patientId}`);
                const patientData = await patientResponse.json();

                // Get health goals
                const goalsResponse = await fetch(`${API_URL}/patients/${patientId}/goals`);
                const goalsData = await goalsResponse.json();

                // Render dashboard
                renderPatientInfo(patientData.patient, patientData.digital_twin);
                renderHealthStatus(patientData.digital_twin);
                renderHealthGoals(goalsData.goals);

                dashboardContent.style.display = 'block';
            } catch (error) {
                console.error('Error loading dashboard:', error);
                alert('Error al cargar el dashboard');
            } finally {
                loading.style.display = 'none';
            }
        }

        function renderPatientInfo(patient, digitalTwin) {
            const age = calculateAge(patient.date_of_birth);

            const html = `
                <div class="info-row">
                    <span class="info-label">Nombre:</span>
                    <span class="info-value">${patient.first_name} ${patient.last_name}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Edad:</span>
                    <span class="info-value">${age} a√±os</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Ciudad:</span>
                    <span class="info-value">${patient.city || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Email:</span>
                    <span class="info-value">${patient.email}</span>
                </div>
            `;

            document.getElementById('patientInfo').innerHTML = html;
        }

        function renderHealthStatus(digitalTwin) {
            const riskClass = `risk-${digitalTwin.risk_level}`;
            const riskLabels = {
                'healthy': 'Saludable',
                'susceptible': 'Susceptible',
                'stable_condition': 'Condici√≥n Estable',
                'high_complexity': 'Alta Complejidad'
            };

            const html = `
                <div class="info-row">
                    <span class="info-label">Nivel de Riesgo:</span>
                    <span class="risk-badge ${riskClass}">${riskLabels[digitalTwin.risk_level]}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Prob. Complicaci√≥n (90d):</span>
                    <span class="info-value">${(digitalTwin.complication_probability_90d * 100).toFixed(1)}%</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Condiciones:</span>
                    <span class="info-value">${digitalTwin.conditions.join(', ') || 'Ninguna'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Controles Pendientes:</span>
                    <span class="info-value">${digitalTwin.pending_controls.length}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Programas Recomendados:</span>
                    <span class="info-value">${digitalTwin.recommended_programs.join(', ') || 'Ninguno'}</span>
                </div>
            `;

            document.getElementById('healthStatus').innerHTML = html;
        }

        function renderHealthGoals(goals) {
            const container = document.getElementById('healthGoals');

            if (!goals || goals.length === 0) {
                container.innerHTML = '<div class="empty-state">No tienes objetivos de salud registrados a√∫n.</div>';
                return;
            }

            const statusLabels = {
                'not_started': 'No Iniciado',
                'in_progress': 'En Progreso',
                'completed': 'Completado',
                'abandoned': 'Abandonado'
            };

            const html = goals.map(goal => `
                <div class="goal-card">
                    <div class="goal-header">
                        <div class="goal-title">${goal.title}</div>
                        <div class="goal-status status-${goal.status}">
                            ${statusLabels[goal.status]}
                        </div>
                    </div>
                    <div class="goal-description">${goal.description || ''}</div>

                    <div class="goal-values">
                        <div class="value-item">
                            <div class="value-label">Valor Actual</div>
                            <div class="value-number">${goal.current_value || 'N/A'}</div>
                        </div>
                        <div class="value-item">
                            <div class="value-label">Valor Objetivo</div>
                            <div class="value-number">${goal.target_value || 'N/A'}</div>
                        </div>
                    </div>

                    <div class="goal-progress">
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${goal.progress_percentage}%">
                                ${goal.progress_percentage.toFixed(0)}%
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function calculateAge(dateOfBirth) {
            const today = new Date();
            const birth = new Date(dateOfBirth);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();

            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }

            return age;
        }

        // Event listeners
        patientSelect.addEventListener('change', (e) => {
            const patientId = e.target.value;
            if (patientId) {
                loadPatientDashboard(patientId);
            } else {
                dashboardContent.style.display = 'none';
            }
        });

        // Load patients on page load
        loadPatients();
    </script>
</body>
</html>
